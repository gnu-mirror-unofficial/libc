<html lang="en">
<head>
<title>The GNU C Library</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name=description content="The GNU C Library">
<meta name=generator content="makeinfo 4.2">
<link href="http://www.gnu.org/software/texinfo/" rel=generator-home>
</head>
<body>
<p>
Node:<a name="Heap%20Consistency%20Checking">Heap Consistency Checking</a>,
Next:<a rel=next accesskey=n href="Hooks-for-Malloc.html#Hooks%20for%20Malloc">Hooks for Malloc</a>,
Previous:<a rel=previous accesskey=p href="Malloc-Tunable-Parameters.html#Malloc%20Tunable%20Parameters">Malloc Tunable Parameters</a>,
Up:<a rel=up accesskey=u href="Unconstrained-Allocation.html#Unconstrained%20Allocation">Unconstrained Allocation</a>
<hr><br>

<h5>Heap Consistency Checking</h5>

<p>You can ask <code>malloc</code> to check the consistency of dynamic memory by
using the <code>mcheck</code> function.  This function is a GNU extension,
declared in <code>mcheck.h</code>.

<p>
<table width="100%">
<tr>
<td align="left">int <b>mcheck</b><i> (void (*<var>abortfn</var>) (enum mcheck_status <var>status</var>))
</i></td>
<td align="right">Function</td>
</tr>
</table>
<table width="95%" align="center">
<tr><td>
Calling <code>mcheck</code> tells <code>malloc</code> to perform occasional
consistency checks.  These will catch things such as writing
past the end of a block that was allocated with <code>malloc</code>.

<p>The <var>abortfn</var> argument is the function to call when an inconsistency
is found.  If you supply a null pointer, then <code>mcheck</code> uses a
default function which prints a message and calls <code>abort</code>
(see <a href="Aborting-a-Program.html#Aborting%20a%20Program">Aborting a Program</a>).  The function you supply is called with
one argument, which says what sort of inconsistency was detected; its
type is described below.

<p>It is too late to begin allocation checking once you have allocated
anything with <code>malloc</code>.  So <code>mcheck</code> does nothing in that
case.  The function returns <code>-1</code> if you call it too late, and
<code>0</code> otherwise (when it is successful).

<p>The easiest way to arrange to call <code>mcheck</code> early enough is to use
the option <code>-lmcheck</code> when you link your program; then you don't
need to modify your program source at all.  Alternatively you might use
a debugger to insert a call to <code>mcheck</code> whenever the program is
started, for example these gdb commands will automatically call <code>mcheck</code>
whenever the program starts:

<br><pre>(gdb) break main
Breakpoint 1, main (argc=2, argv=0xbffff964) at whatever.c:10
(gdb) command 1
Type commands for when breakpoint 1 is hit, one per line.
End with a line saying just "end".
&gt;call mcheck(0)
&gt;continue
&gt;end
(gdb) ...
</pre>

<p>This will however only work if no initialization function of any object
involved calls any of the <code>malloc</code> functions since <code>mcheck</code>
must be called before the first such function.

</td></tr>
</table>

<p>
<table width="100%">
<tr>
<td align="left">enum mcheck_status <b>mprobe</b><i> (void *<var>pointer</var>)
</i></td>
<td align="right">Function</td>
</tr>
</table>
<table width="95%" align="center">
<tr><td>
The <code>mprobe</code> function lets you explicitly check for inconsistencies
in a particular allocated block.  You must have already called
<code>mcheck</code> at the beginning of the program, to do its occasional
checks; calling <code>mprobe</code> requests an additional consistency check
to be done at the time of the call.

<p>The argument <var>pointer</var> must be a pointer returned by <code>malloc</code>
or <code>realloc</code>.  <code>mprobe</code> returns a value that says what
inconsistency, if any, was found.  The values are described below. 
</td></tr>
</table>

<p>
<table width="100%">
<tr>
<td align="left"><b>enum mcheck_status</b><i>
</i></td>
<td align="right">Data Type</td>
</tr>
</table>
<table width="95%" align="center">
<tr><td>
This enumerated type describes what kind of inconsistency was detected
in an allocated block, if any.  Here are the possible values:

<dl>
<dt><code>MCHECK_DISABLED</code>
<dd><code>mcheck</code> was not called before the first allocation. 
No consistency checking can be done. 
<br><dt><code>MCHECK_OK</code>
<dd>No inconsistency detected. 
<br><dt><code>MCHECK_HEAD</code>
<dd>The data immediately before the block was modified. 
This commonly happens when an array index or pointer
is decremented too far. 
<br><dt><code>MCHECK_TAIL</code>
<dd>The data immediately after the block was modified. 
This commonly happens when an array index or pointer
is incremented too far. 
<br><dt><code>MCHECK_FREE</code>
<dd>The block was already freed. 
</dl>
</td></tr>
</table>

<p>Another possibility to check for and guard against bugs in the use of
<code>malloc</code>, <code>realloc</code> and <code>free</code> is to set the environment
variable <code>MALLOC_CHECK_</code>.  When <code>MALLOC_CHECK_</code> is set, a
special (less efficient) implementation is used which is designed to be
tolerant against simple errors, such as double calls of <code>free</code> with
the same argument, or overruns of a single byte (off-by-one bugs).  Not
all such errors can be protected against, however, and memory leaks can
result.  If <code>MALLOC_CHECK_</code> is set to <code>0</code>, any detected heap
corruption is silently ignored; if set to <code>1</code>, a diagnostic is
printed on <code>stderr</code>; if set to <code>2</code>, <code>abort</code> is called
immediately.  This can be useful because otherwise a crash may happen
much later, and the true cause for the problem is then very hard to
track down.

<p>There is one problem with <code>MALLOC_CHECK_</code>: in SUID or SGID binaries
it could possibly be exploited since diverging from the normal programs
behavior it now writes something to the standard error descriptor. 
Therefore the use of <code>MALLOC_CHECK_</code> is disabled by default for
SUID and SGID binaries.  It can be enabled again by the system
administrator by adding a file <code>/etc/suid-debug</code> (the content is
not important it could be empty).

<p>So, what's the difference between using <code>MALLOC_CHECK_</code> and linking
with <code>-lmcheck</code>?  <code>MALLOC_CHECK_</code> is orthogonal with respect to
<code>-lmcheck</code>.  <code>-lmcheck</code> has been added for backward
compatibility.  Both <code>MALLOC_CHECK_</code> and <code>-lmcheck</code> should
uncover the same bugs - but using <code>MALLOC_CHECK_</code> you don't need to
recompile your application.

</body></html>

